<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google Cloud Storage • cloudml</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">CloudML for R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Guides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/training.html">Training with CloudML</a>
    </li>
    <li>
      <a href="../articles/training.html">Deploying Models</a>
    </li>
    <li>
      <a href="../articles/tuning.html">Hyperparameter Tuning</a>
    </li>
    <li>
      <a href="../articles/storage.html">Google Cloud Storage</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/cloudml">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Google Cloud Storage</h1>
            
          </div>

    
    
<div class="contents">
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p><a href="https://cloud.google.com/storage/">Google Cloud Storage</a> is often used along with CloudML to manage and serve training data. This article provides details on:</p>
<ul>
<li><p>Copying and synchronizing files between your local workstation and Google Cloud.</p></li>
<li><p>Reading data from Google Cloud Storage buckets from within a training script.</p></li>
<li><p>Varying data source configuration between local script development and CloudML training.</p></li>
</ul>
</div>
<div id="copying-data" class="section level2">
<h2 class="hasAnchor">
<a href="#copying-data" class="anchor"></a>Copying Data</h2>
<p>Google Cloud Storage is organized around storage units named “buckets”, which are roughly analogous to filesystem directories. You can copy data between your local system and cloud storage using the <code><a href="../reference/gs_copy.html">gs_copy()</a></code> function. For example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(cloudml)

<span class="co"># copy from a local directory to a bucket</span>
<span class="kw"><a href="../reference/gs_copy.html">gs_copy</a></span>(<span class="st">"training-data"</span>, <span class="st">"gs://quarter-deck-529/training-data"</span>)

<span class="co"># copy from a bucket to a local directory </span>
<span class="kw"><a href="../reference/gs_copy.html">gs_copy</a></span>(<span class="st">"gs://quarter-deck-529/training-data"</span>, <span class="st">"training-data"</span>)</code></pre></div>
<p>You can also use the <code><a href="../reference/gs_rsync.html">gs_rsync()</a></code> function to syncrhonize a local directory and a bucket in Google Storage (this is much more efficient than copying the data each time):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># synchronize a bucket and a local directory</span>
<span class="kw"><a href="../reference/gs_rsync.html">gs_rsync</a></span>(<span class="st">"gs://quarter-deck-529/training-data"</span>, <span class="st">"training-data"</span>)</code></pre></div>
<p>Note that to use these functions you need to import the cloudml package with <code>library(cloudml)</code> as illustrated above.</p>
</div>
<div id="reading-data" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-data" class="anchor"></a>Reading Data</h2>
<p>Some TensorFlow APIs can take <code>gs://</code> URLs directly however most often you will need a local filesystem path to a data source in order to read it. If you want to store data in Google Storage but still use it with APIs that require local paths you can use the <code><a href="../reference/gs_local_dir.html">gs_local_dir()</a></code> function to provide the local path.</p>
<p>For example, this code reads CSV files from Google Storage:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(cloudml)
<span class="kw">library</span>(readr)
data_dir &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gs_local_dir.html">gs_local_dir</a></span>(<span class="st">"gs://quarter-deck-529/training-data"</span>)
train_data &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/readr/topics/read_delim">read_csv</a></span>(<span class="kw">file.path</span>(data_dir, <span class="st">"train.csv"</span>))
test_data &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/readr/topics/read_delim">read_csv</a></span>(<span class="kw">file.path</span>(data_dir, <span class="st">"test.csv"</span>))</code></pre></div>
<p>Under the hood this function will rsync data from Google Storage as required to provide the local filesystem interface to it.</p>
<p>Here’s another example which creates a Keras image data generator from a bucket:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">train_generator &lt;-<span class="st"> </span><span class="kw">flow_images_from_directory</span>(
  <span class="kw"><a href="../reference/gs_local_dir.html">gs_local_dir</a></span>(<span class="st">"gs://quarter-deck-529/images/train"</span>),
  <span class="kw">image_data_generator</span>(<span class="dt">rescale =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">255</span>),
  <span class="dt">target_size =</span> <span class="kw">c</span>(<span class="dv">150</span>, <span class="dv">150</span>),
  <span class="dt">batch_size =</span> <span class="dv">32</span>
  <span class="dt">class_mode =</span> <span class="st">"binary"</span>
)</code></pre></div>
<p>Note that if the path passed to <code><a href="../reference/gs_local_dir.html">gs_local_dir()</a></code> is from the local filesystem it will be returned unmodified.</p>
</div>
<div id="data-source-configuration" class="section level2">
<h2 class="hasAnchor">
<a href="#data-source-configuration" class="anchor"></a>Data Source Configuration</h2>
<p>It’s often useful to do training script development with a local subsample of data that you’ve extracted from the complete set of training data. In this configuration, you’ll want your training script to dynamically use the local subsample during development then use the complete dataset stored in Google Cloud Storage when running on CloudML. You can accomplish this with a combination of <a href="(https://tensorflow.rstudio.com/tools/training_flags.html)">training flags</a> and the <code><a href="../reference/gs_local_dir.html">gs_local_dir()</a></code> function described above.</p>
<p>Here’s a complete example. We start with a training script that declares a flag for the location of the training data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(keras)
<span class="kw">library</span>(cloudml)

<span class="co"># define a flag for the location of the data directory</span>
FLAGS &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/keras/topics/reexports">flags</a></span>(
  <span class="kw"><a href="http://www.rdocumentation.org/packages/keras/topics/reexports">flag_string</a></span>(<span class="st">"data_dir"</span>, <span class="st">"data"</span>)
)

<span class="co"># determine the location of the directory (during local development this will</span>
<span class="co"># be the default "data" subdirectory specified in the FLAGS declaration above)</span>
data_dir &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gs_local_dir.html">gs_local_dir</a></span>(FLAGS<span class="op">$</span>data_dir)

<span class="co"># read the data</span>
train_data &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/readr/topics/read_delim">read_csv</a></span>(<span class="kw">file.path</span>(FLAGS<span class="op">$</span>data_dir, <span class="st">"train.csv"</span>))</code></pre></div>
<p>Note that the <code>data_dir</code> R variable is computed by passing <code>FLAGS$data_dir</code> to the <code><a href="../reference/gs_local_dir.html">gs_local_dir()</a></code> function. This enables it to take on a dynamic value depending upon the training environment.</p>
<p>The way to vary this value when running on CloudML is by adding a <code>flags.yml</code> configuration file to your project directory. For example:</p>
<p><strong>flags.yml</strong></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">cloudml:</span>
  <span class="fu">data_dir:</span><span class="at"> </span><span class="st">"gs://quarter-deck-529/training-data"</span></code></pre></div>
<p>With the addition of this config file, your script will resolve the <code>data_dir</code> flag to specified the Google Storage bucket, but only when it is running on CloudML.</p>
</div>
<div id="managing-storage" class="section level2">
<h2 class="hasAnchor">
<a href="#managing-storage" class="anchor"></a>Managing Storage</h2>
<p>You can view and manage data within Google Cloud Storage buckets using either a web based user-interface or via command line utilities included with the Google Cloud SDK.</p>
<div id="google-storage-browser" class="section level3">
<h3 class="hasAnchor">
<a href="#google-storage-browser" class="anchor"></a>Google Storage Browser</h3>
<p>To access the web-bqsed UI, navigate to <a href="https://console.cloud.google.com/storage/browser" class="uri">https://console.cloud.google.com/storage/browser</a>.</p>
<p>Here’s what the storage browser looks like for a sample project:</p>
<div class="figure">
<img src="images/google-storage-browser.png" class="screenshot" width="725">
</div>
</div>
<div id="google-cloud-sdk" class="section level3">
<h3 class="hasAnchor">
<a href="#google-cloud-sdk" class="anchor"></a>Google Cloud SDK</h3>
<p>The Google Cloud SDK includes the <code>gsutil</code> utility program for managing cloud storage buckets. Documentation for <code>gsutil</code> can be found here: <a href="https://cloud.google.com/storage/docs/gsutil" class="uri">https://cloud.google.com/storage/docs/gsutil</a>.</p>
<p>You use <code>gsutil</code> from within a terminal. If you are running within RStudio v1.1 or higher you can activate a terminal with the <code><a href="../reference/gcloud_terminal.html">gcloud_terminal()</a></code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/gcloud_terminal.html">gcloud_terminal</a></span>()</code></pre></div>
<p>Here is an example of using the <code>gsutil ls</code> command to list the contents of a bucket within a terminal:</p>
<div class="figure">
<img src="images/google-storage-terminal.png" class="screenshot" width="725">
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#copying-data">Copying Data</a></li>
      <li><a href="#reading-data">Reading Data</a></li>
      <li><a href="#data-source-configuration">Data Source Configuration</a></li>
      <li><a href="#managing-storage">Managing Storage</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Javier Luraschi, JJ Allaire, Kevin Ushey.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
